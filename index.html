<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…«å¦æ’ç›˜å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-bottom: 3px solid #3498db;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            color: #ecf0f1;
        }
        
        main {
            padding: 30px;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            font-size: 1.8em;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            width: 100%;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            letter-spacing: 1px;
        }
        
        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .calculate-btn:active {
            transform: translateY(-1px);
        }
        
        .calculate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
            border: 2px solid #3498db;
            display: none;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .result-title {
            color: #2c3e50;
            font-size: 1.8em;
        }
        
        .result-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .status-favorable {
            background: #d4edda;
            color: #155724;
        }
        
        .status-unfavorable {
            background: #f8d7da;
            color: #721c24;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .result-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .result-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .result-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .result-description {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-top: 25px;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
            white-space: pre-wrap;
            border: 1px solid #e9ecef;
        }
        
        .separator {
            text-align: center;
            margin: 20px 0;
            color: #3498db;
            font-weight: bold;
            letter-spacing: 3px;
        }
        
        .gua-explanation {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            border-left: 4px solid #3498db;
        }
        
        .gua-explanation h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .gua-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .gua-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .gua-name {
            font-weight: bold;
            color: #2c3e50;
            margin-right: 10px;
        }
        
        .gua-meaning {
            color: #666;
        }
        
        .history-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
            border: 1px solid #e9ecef;
        }
        
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .history-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #666;
            font-size: 0.9em;
        }
        
        .history-content {
            color: #333;
        }
        
        .clear-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
        }
        
        .clear-btn:hover {
            background: #c0392b;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            background: #2c3e50;
            color: white;
            margin-top: 40px;
            border-top: 3px solid #3498db;
        }
        
        .copyright {
            opacity: 0.8;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            header {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            main {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .result-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å…«å¦æ’ç›˜å·¥å…·</h1>
            <p class="subtitle">åŸºäºæ˜“ç»å…«å¦çš„å§“åæ—¶ç©ºèƒ½é‡åˆ†æç³»ç»Ÿ</p>
        </header>
        
        <main>
            <section class="input-section">
                <h2>ğŸ”® æ’ç›˜ä¿¡æ¯è¾“å…¥</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="name">å§“åï¼ˆå¿…å¡«ï¼‰</label>
                        <input type="text" id="name" placeholder="è¯·è¾“å…¥å§“å" value="å¼ ä¸‰" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="date">æŸ¥è¯¢æ—¥æœŸï¼ˆå¿…å¡«ï¼‰</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="hour">æ—¶è¾°ï¼ˆ0-23ç‚¹ï¼‰</label>
                        <input type="number" id="hour" min="0" max="23" value="12" required>
                        <small style="color: #666; font-size: 0.9em;">å­æ—¶(23-1) ä¸‘æ—¶(1-3) ... äº¥æ—¶(21-23)</small>
                    </div>
                </div>
                
                <button id="calculateBtn" class="calculate-btn" onclick="calculate()">
                    ğŸ¯ å¼€å§‹æ’ç›˜è®¡ç®—
                </button>
                
                <div id="errorMessage" class="error-message"></div>
                <div id="successMessage" class="success-message"></div>
            </section>
            
            <section id="resultSection" class="result-section">
                <div class="result-header">
                    <h3 class="result-title">ğŸ“Š æ’ç›˜ç»“æœ</h3>
                    <div id="resultStatus" class="result-status status-favorable">æœ‰åˆ©</div>
                </div>
                
                <div class="result-grid">
                    <div class="result-card">
                        <h4>ğŸ“ åŸºç¡€ä¿¡æ¯</h4>
                        <p><strong>å§“åï¼š</strong><span id="resultName">-</span></p>
                        <p><strong>æ—¶é—´ï¼š</strong><span id="resultDate">-</span></p>
                        <p><strong>æ—¶è¾°ï¼š</strong><span id="resultHour">-</span>æ—¶</p>
                    </div>
                    
                    <div class="result-card">
                        <h4>ğŸ–‹ï¸ ç¬”ç”»ç»Ÿè®¡</h4>
                        <p><strong>å§“åç¬”ç”»ï¼š</strong><span id="resultStrokes">-</span></p>
                        <p><strong>å¤©æ—¶æ€»æ•°ï¼š</strong><span id="resultTianShi">-</span></p>
                        <p><strong>æ—¶è¾°ç¬”ç”»ï¼š</strong><span id="resultHourStroke">-</span></p>
                        <p><strong>æ€»å’Œï¼š</strong><span id="resultTotal">-</span></p>
                    </div>
                    
                    <div class="result-card">
                        <h4>ğŸ§® å…«å¦å¦è±¡</h4>
                        <p><strong>ä¸Šå¦ï¼š</strong><span id="resultShangGua">-</span></p>
                        <p><strong>ä¸‹å¦ï¼š</strong><span id="resultXiaGua">-</span></p>
                        <p><strong>åŠ¨çˆ»ï¼š</strong>ç¬¬<span id="resultDongYao">-</span>çˆ»</p>
                        <p><strong>å˜å¦ï¼š</strong><span id="resultBianGua">-</span></p>
                    </div>
                    
                    <div class="result-card">
                        <h4>ğŸ—“ï¸ å¹²æ”¯æ—¶è¾°</h4>
                        <p><strong>å¹´æŸ±ï¼š</strong><span id="resultYearGZ">-</span></p>
                        <p><strong>æœˆæŸ±ï¼š</strong><span id="resultMonthGZ">-</span></p>
                        <p><strong>æ—¥æŸ±ï¼š</strong><span id="resultDayGZ">-</span></p>
                        <p><strong>æ—¶æŸ±ï¼š</strong><span id="resultHourGZ">-</span></p>
                    </div>
                </div>
                
                <div class="result-description" id="fullDescription">
                    <!-- å®Œæ•´æè¿°å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <div class="gua-explanation">
                    <h4>ğŸ“– å¦è±¡è¯¦è§£</h4>
                    <div class="gua-item">
                        <span class="gua-name" id="explainShangGua">ä¸Šå¦ï¼š</span>
                        <span class="gua-meaning" id="explainShang">-</span>
                    </div>
                    <div class="gua-item">
                        <span class="gua-name" id="explainXiaGua">ä¸‹å¦ï¼š</span>
                        <span class="gua-meaning" id="explainXia">-</span>
                    </div>
                    <div class="gua-item">
                        <span class="gua-name" id="explainBianGua">å˜å¦ï¼š</span>
                        <span class="gua-meaning" id="explainBian">-</span>
                    </div>
                    <div class="gua-item">
                        <span class="gua-name" id="explainDongYao">åŠ¨çˆ»ï¼š</span>
                        <span class="gua-meaning" id="explainYao">-</span>
                    </div>
                    <div class="gua-item">
                        <span class="gua-name">ç»¼åˆåˆ¤æ–­ï¼š</span>
                        <span class="gua-meaning" id="explainConclusion">-</span>
                    </div>
                </div>
            </section>
            
            <section class="history-section">
                <h2>ğŸ“œ å†å²è®°å½•</h2>
                <button id="clearHistoryBtn" class="clear-btn" onclick="clearHistory()">æ¸…ç©ºå†å²è®°å½•</button>
                <div class="history-list" id="historyList">
                    <!-- å†å²è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </section>
        </main>
        
        <footer>
            <p>Â© 2024 å…«å¦æ’ç›˜å·¥å…· - åŸºäºæ˜“ç»å…«å¦ç®—æ³•</p>
            <p class="copyright">ä»…ç”¨äºä¼ ç»Ÿæ–‡åŒ–ç ”ç©¶å‚è€ƒ</p>
        </footer>
    </div>

    <!-- å¼•å…¥JSæ–‡ä»¶ -->
    <script src="js/sum-strokes-utils.js"></script>
    <script src="js/bagua-core.js"></script>
    
    <script>
        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('date').value = formattedDate;
            
            // åŠ è½½å†å²è®°å½•
            loadHistory();
        });
        
        // ==================== ç¬”ç”»è®¡ç®—åº“ï¼ˆå¤‡ç”¨ï¼‰ ====================
        const STROKE_DICT = {
            // æ•°å­—
            'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':5,'äº”':4,'å…­':4,'ä¸ƒ':2,'å…«':2,'ä¹':2,'å':2,'é›¶':13,'ç™¾':6,'åƒ':3,'ä¸‡':3,
            
            // å§“æ°å¸¸ç”¨å­—
            'å¼ ':7,'ç‹':4,'æ':7,'èµµ':9,'åˆ˜':6,'é™ˆ':7,'æ¨':7,'é»„':11,'å‘¨':8,'å´':7,'å¾':10,'å­™':6,'é©¬':3,
            'æœ±':6,'èƒ¡':9,'éƒ­':10,'æ—':8,'ä½•':7,'é«˜':10,'æ¢':11,'éƒ‘':8,'è°¢':12,'å®‹':7,'å”':10,'è®¸':6,'éŸ©':12,
            'å†¯':5,'é‚“':4,'æ›¹':11,'æ›¾':12,'å½­':12,'è‚–':7,'ç”°':5,'è‘£':12,'æ½˜':15,'è¢':10,'äº':3,'è’‹':12,'è”¡':14,
            'ä½™':7,'æœ':7,'å¶':5,'ç¨‹':12,'è‹':7,'é­':17,'å•':7,'ä¸':2,'ä»»':6,'æ²ˆ':7,'å§š':9,
            
            // åå­—å¸¸ç”¨å­—
            'æ˜':8,'å':6,'å›½':8,'æ–‡':4,'å†›':6,'å»º':8,'å¿—':7,'ä¼Ÿ':6,'å¼º':11,'æ°':8,'å¹³':5,'æµ·':10,'æ¶›':10,
            'æ–Œ':11,'é£':3,'å®‡':6,'æµ©':10,'è¶…':12,'å‹‡':9,'å³°':10,'åˆš':6,'æ—':8,'ä¸œ':5,'è¾‰':12,'é¾™':5,'é˜³':6,
            'å¤':8,'äº®':9,'é¹':13,'æ¯…':15,'å¨':9,'æ™¨':11,'é‘«':24,'åš':12,'æ£®':12,'æ´‹':9,'ç£Š':15,'å¸…':5,'ç¿”':12,
            'è™':8,'æ˜Œ':8,'ç››':11,'é›·':13,'ä¸¹':4,'å©·':12,'èŠ³':7,'å¨œ':9,'æ•':11,'é™':14,'ä¸½':7,'é¢–':16,'ç³':12,
            'å¨Ÿ':10,'ç‡•':16,'ç²':9,'çº¢':6,'ç‰':5,'è‹±':8,'æ¢…':11,'é›ª':11,'äº‘':4,'å‡¤':4,'å…°':5,'æ·‘':11,'æ´':9,
            'ç§€':7,'ç':9,'ç ':10,'ç´':12,'éœ':17,
            
            // å…«å¦ç›¸å…³
            'ä¹¾':11,'å¤':8,'éœ‡':15,'å·½':12,'å':8,'ç¦»':11,'è‰®':6,'å…‘':7
        };
        
        // å¢å¼ºçš„ç¬”ç”»è®¡ç®—å‡½æ•°
        function getStrokeCountEnhanced(name) {
            if (!name || typeof name !== 'string') return 0;
            
            // æ–¹æ³•1ï¼šä½¿ç”¨ç¬”ç”»åº“
            if (window.SumStrokesNumUtils && typeof window.SumStrokesNumUtils.GetStrokeCount === 'function') {
                try {
                    const count = SumStrokesNumUtils.GetStrokeCount(name);
                    if (count > 0) {
                        console.log(`[ç¬”ç”»åº“] "${name}" = ${count}ç”»`);
                        return count;
                    }
                } catch (e) {
                    console.warn('ç¬”ç”»åº“è®¡ç®—å¤±è´¥:', e);
                }
            }
            
            // æ–¹æ³•2ï¼šä½¿ç”¨å¤‡ç”¨å­—å…¸
            return calculateStrokeBackup(name);
        }
        
        // å¤‡ç”¨ç¬”ç”»è®¡ç®—
        function calculateStrokeBackup(name) {
            let total = 0;
            for (let i = 0; i < name.length; i++) {
                const char = name[i];
                if (STROKE_DICT[char]) {
                    total += STROKE_DICT[char];
                } else {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºä¸­æ–‡å­—ç¬¦
                    const code = char.charCodeAt(0);
                    if (code >= 0x4E00 && code <= 0x9FA5) {
                        // ä¸­æ–‡å­—ç¬¦ï¼Œé»˜è®¤8ç”»
                        total += 8;
                    }
                }
            }
            console.log(`[å¤‡ç”¨ç¬”ç”»] "${name}" = ${total}ç”»`);
            return total;
        }
        
        // ==================== è®¡ç®—å‡½æ•° ====================
        async function calculate() {
            try {
                // è·å–è¾“å…¥å€¼
                const name = document.getElementById('name').value.trim();
                const date = document.getElementById('date').value;
                const hour = parseInt(document.getElementById('hour').value);
                
                // éªŒè¯è¾“å…¥
                if (!name) {
                    showError('è¯·è¾“å…¥å§“å');
                    return;
                }
                
                if (!date) {
                    showError('è¯·é€‰æ‹©æ—¥æœŸ');
                    return;
                }
                
                if (isNaN(hour) || hour < 0 || hour > 23) {
                    showError('æ—¶è¾°å¿…é¡»åœ¨0-23ä¹‹é—´');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const btn = document.getElementById('calculateBtn');
                btn.disabled = true;
                btn.innerHTML = 'ğŸ”® è®¡ç®—ä¸­...';
                
                // æ‰‹åŠ¨è®¡ç®—ç¬”ç”»
                const strokeCount = getStrokeCountEnhanced(name);
                
                // åˆ›å»ºè®¡ç®—å™¨å®ä¾‹
                const calculator = new RunQG();
                
                // æ‰§è¡Œè®¡ç®—
                const result = await calculator.calculate(name, date, hour);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                btn.innerHTML = 'ğŸ¯ å¼€å§‹æ’ç›˜è®¡ç®—';
                
                // å¤„ç†ç»“æœ
                if (result.success) {
                    displayResult(result.data, strokeCount);
                    saveHistory(result.data, strokeCount);
                    loadHistory();
                    showSuccess('æ’ç›˜è®¡ç®—å®Œæˆï¼');
                } else {
                    showError('è®¡ç®—å¤±è´¥ï¼š' + result.error);
                }
                
            } catch (error) {
                console.error('è®¡ç®—é”™è¯¯:', error);
                showError('ç³»ç»Ÿé”™è¯¯ï¼š' + error.message);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const btn = document.getElementById('calculateBtn');
                btn.disabled = false;
                btn.innerHTML = 'ğŸ¯ å¼€å§‹æ’ç›˜è®¡ç®—';
            }
        }
        
        // ==================== ç»“æœæ˜¾ç¤º ====================
        function displayResult(data, strokeCount) {
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            const resultSection = document.getElementById('resultSection');
            resultSection.style.display = 'block';
            
            // å¡«å……åŸºç¡€ä¿¡æ¯
            document.getElementById('resultName').textContent = data.name;
            document.getElementById('resultDate').textContent = data.date;
            document.getElementById('resultHour').textContent = data.hour;
            
            // å¡«å……ç¬”ç”»ä¿¡æ¯ï¼ˆä½¿ç”¨æ‰‹åŠ¨è®¡ç®—çš„ç¬”ç”»ï¼‰
            document.getElementById('resultStrokes').textContent = strokeCount;
            document.getElementById('resultTianShi').textContent = data.tianShiSum;
            document.getElementById('resultHourStroke').textContent = data.hourStroke;
            
            // è®¡ç®—å¹¶æ˜¾ç¤ºæ€»å’Œ
            const totalSum = data.tianShiSum + strokeCount + data.hourStroke;
            document.getElementById('resultTotal').textContent = totalSum;
            
            // å¡«å……å¦è±¡ä¿¡æ¯
            document.getElementById('resultShangGua').textContent = data.shangGua;
            document.getElementById('resultXiaGua').textContent = data.xiaGua;
            document.getElementById('resultDongYao').textContent = data.dongYao;
            document.getElementById('resultBianGua').textContent = data.bianGua;
            
            // å¡«å……å¹²æ”¯ä¿¡æ¯
            document.getElementById('resultYearGZ').textContent = data.yearStemBranch || '-';
            document.getElementById('resultMonthGZ').textContent = data.monthStemBranch || '-';
            document.getElementById('resultDayGZ').textContent = data.dayStemBranch || '-';
            document.getElementById('resultHourGZ').textContent = data.hourStemBranch || '-';
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const statusElement = document.getElementById('resultStatus');
            if (data.isFavorable) {
                statusElement.textContent = 'æœ‰åˆ©';
                statusElement.className = 'result-status status-favorable';
            } else {
                statusElement.textContent = 'éœ€è°¨æ…';
                statusElement.className = 'result-status status-unfavorable';
            }
            
            // ç”Ÿæˆå®Œæ•´çš„æè¿°æ–‡æœ¬
            const fullDescription = generateFullDescription(data, strokeCount, totalSum);
            document.getElementById('fullDescription').textContent = fullDescription;
            
            // æ˜¾ç¤ºå¦è±¡è§£é‡Š
            displayGuaExplanation(data);
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ç”Ÿæˆå®Œæ•´æè¿°
        function generateFullDescription(data, strokeCount, totalSum) {
            return `å§“åï¼š${data.name}
æ—¶é—´ï¼š${data.date} ${data.hour}æ—¶
${'='.repeat(30)}
å§“åç¬”ç”»ï¼š${strokeCount}
å¤©æ—¶æ€»æ•°ï¼š${data.tianShiSum}
æ—¶è¾°ç¬”ç”»ï¼š${data.hourStroke}
æ€»    å’Œï¼š${totalSum}
${'='.repeat(30)}
å¹´æŸ±ï¼š${data.yearStemBranch || '-'}
æœˆæŸ±ï¼š${data.monthStemBranch || '-'}
æ—¥æŸ±ï¼š${data.dayStemBranch || '-'}
æ—¶æŸ±ï¼š${data.hourStemBranch || '-'}
${'='.repeat(30)}
ä¸Š  å¦ï¼š${data.shangGua}
ä¸‹  å¦ï¼š${data.xiaGua}
åŠ¨  çˆ»ï¼šç¬¬${data.dongYao}çˆ»
å˜  å¦ï¼š${data.bianGua}
${'='.repeat(30)}
å˜å¦æœ‰åˆ©ï¼š${data.isFavorable ? 'âœ“' : 'âœ—'}
${'='.repeat(30)}
è§£æï¼š${getGuaInterpretation(data.shangGua, data.xiaGua, data.bianGua, data.dongYao)}`;
        }
        
        // æ˜¾ç¤ºå¦è±¡è§£é‡Š
        function displayGuaExplanation(data) {
            const guaMeanings = {
                'ä¹¾': 'ä·€ ä¹¾ä¸ºå¤©ï¼šè±¡å¾å¤©ï¼Œä»£è¡¨åˆšå¥ã€åˆ›å§‹ã€é¢†å¯¼ã€‚åˆšå¥æœ‰åŠ›ï¼Œè‡ªå¼ºä¸æ¯ã€‚',
                'å¤': 'ä· å¤ä¸ºåœ°ï¼šè±¡å¾åœ°ï¼Œä»£è¡¨æŸ”é¡ºã€æ‰¿è½½ã€åŒ…å®¹ã€‚åšå¾·è½½ç‰©ï¼ŒåŒ…å®¹ä¸‡ç‰©ã€‚',
                'å…‘': 'ä·¹ å…‘ä¸ºæ³½ï¼šè±¡å¾æ³½ï¼Œä»£è¡¨å–œæ‚¦ã€äº¤æµã€æ²Ÿé€šã€‚å’Œæ‚¦å¾…äººï¼Œè¨€è¯­æ²Ÿé€šã€‚',
                'ç¦»': 'ä· ç¦»ä¸ºç«ï¼šè±¡å¾ç«ï¼Œä»£è¡¨å…‰æ˜ã€ç¾ä¸½ã€ä¾é™„ã€‚å…‰æ˜ç£Šè½ï¼Œç¾ä¸½ä¾é™„ã€‚',
                'éœ‡': 'ä·² éœ‡ä¸ºé›·ï¼šè±¡å¾é›·ï¼Œä»£è¡¨è¡ŒåŠ¨ã€éœ‡åŠ¨ã€å¥‹å‘ã€‚é›·å‰é£è¡Œï¼Œå¥‹å‘å‘ä¸Šã€‚',
                'å·½': 'ä·¸ å·½ä¸ºé£ï¼šè±¡å¾é£ï¼Œä»£è¡¨é¡ºä»ã€è¿›å…¥ã€æ¸—é€ã€‚éšé£æ½œå…¥ï¼Œæ— å­”ä¸å…¥ã€‚',
                'å': 'ä·œ åä¸ºæ°´ï¼šè±¡å¾æ°´ï¼Œä»£è¡¨é™©é™·ã€æ™ºæ…§ã€æµåŠ¨ã€‚é™©ä¸­æ±‚æ™ºï¼ŒæµåŠ¨ä¸å±…ã€‚',
                'è‰®': 'ä·³ è‰®ä¸ºå±±ï¼šè±¡å¾å±±ï¼Œä»£è¡¨åœæ­¢ã€ç¨³é‡ã€é™æ­¢ã€‚ç¨³é‡å¦‚å±±ï¼Œé€‚å¯è€Œæ­¢ã€‚'
            };
            
            const yaoMeanings = {
                1: 'åˆçˆ»ï¼šäº‹ç‰©åˆå§‹é˜¶æ®µï¼Œæ ¹åŸºæœªç¨³ï¼Œéœ€è°¨æ…è¡Œäº‹ï¼Œæ‰“å¥½åŸºç¡€ã€‚',
                2: 'äºŒçˆ»ï¼šäº‹ç‰©å‘å±•æœŸï¼Œæ¸å…¥ä½³å¢ƒï¼Œå®œç§¯æè¿›å–ï¼ŒæŠŠæ¡æ—¶æœºã€‚',
                3: 'ä¸‰çˆ»ï¼šäº‹ç‰©è½¬æŠ˜ç‚¹ï¼Œé¢ä¸´é€‰æ‹©ï¼Œéœ€æ³¨æ„é£é™©ï¼Œå®¡æ—¶åº¦åŠ¿ã€‚',
                4: 'å››çˆ»ï¼šæ¥è¿‘æˆåŠŸï¼Œä½†ä»æœ‰æŒ‘æˆ˜ï¼Œéœ€æˆ’éª„æˆ’èºï¼Œç¨³æ­¥å‰è¿›ã€‚',
                5: 'äº”çˆ»ï¼šé¼ç››æ—¶æœŸï¼Œä½ç½®å°Šè´µï¼ŒæŠŠæ¡æ—¶æœºï¼Œå¯æˆå¤§ä¸šã€‚',
                6: 'ä¸Šçˆ»ï¼šäº‹ç‰©ç»ˆç»“ï¼Œç‰©æå¿…åï¼Œæ€»ç»“åæ€ï¼Œé€‚å¯è€Œæ­¢ã€‚'
            };
            
            // æ›´æ–°è§£é‡Šæ–‡æœ¬
            document.getElementById('explainShangGua').textContent = `ä¸Šå¦ï¼ˆ${data.shangGua}ï¼‰ï¼š`;
            document.getElementById('explainShang').textContent = guaMeanings[data.shangGua] || 'æ­¤å¦è±¡éœ€ç»“åˆå…·ä½“æƒ…å†µåˆ†æã€‚';
            
            document.getElementById('explainXiaGua').textContent = `ä¸‹å¦ï¼ˆ${data.xiaGua}ï¼‰ï¼š`;
            document.getElementById('explainXia').textContent = guaMeanings[data.xiaGua] || 'æ­¤å¦è±¡éœ€ç»“åˆå…·ä½“æƒ…å†µåˆ†æã€‚';
            
            document.getElementById('explainBianGua').textContent = `å˜å¦ï¼ˆ${data.bianGua}ï¼‰ï¼š`;
            document.getElementById('explainBian').textContent = guaMeanings[data.bianGua] || 'æ­¤å¦è±¡éœ€ç»“åˆå…·ä½“æƒ…å†µåˆ†æã€‚';
            
            document.getElementById('explainDongYao').textContent = `åŠ¨çˆ»ï¼ˆç¬¬${data.dongYao}çˆ»ï¼‰ï¼š`;
            document.getElementById('explainYao').textContent = yaoMeanings[data.dongYao] || '';
            
            // ç»¼åˆåˆ¤æ–­
            let conclusion = '';
            if (data.isFavorable) {
                conclusion = 'âœ“ å˜å¦æœ‰åˆ©ï¼Œæ—¶æœºè¾ƒä¸ºæœ‰åˆ©ï¼Œå¯ç§¯ææŠŠæ¡ã€‚';
            } else {
                conclusion = 'â–³ å˜å¦éœ€è°¨æ…ï¼Œæ—¶æœºå¯èƒ½ä¸å®Œå…¨æˆç†Ÿï¼Œå»ºè®®å®¡æ…è¡Œäº‹ã€‚';
            }
            
            // æ ¹æ®å…­å†²åˆ¤æ–­
            if (data.zhuGuaLc || data.bianGuaLc) {
                conclusion += ' å¦è±¡æ˜¾ç¤ºæœ‰å†²ï¼Œéœ€æ³¨æ„åè°ƒå¹³è¡¡ã€‚';
            }
            
            document.getElementById('explainConclusion').textContent = conclusion;
        }
        
        // å¦è±¡è§£æ
        function getGuaInterpretation(shangGua, xiaGua, bianGua, dongYao) {
            const meanings = {
                'ä¹¾': 'åˆšå¥ã€åˆ›å§‹ã€é¢†å¯¼',
                'å¤': 'æŸ”é¡ºã€æ‰¿è½½ã€åŒ…å®¹',
                'å…‘': 'å–œæ‚¦ã€äº¤æµã€æ²Ÿé€š',
                'ç¦»': 'å…‰æ˜ã€ç¾ä¸½ã€ä¾é™„',
                'éœ‡': 'è¡ŒåŠ¨ã€éœ‡åŠ¨ã€å¥‹å‘',
                'å·½': 'é¡ºä»ã€è¿›å…¥ã€æ¸—é€',
                'å': 'é™©é™·ã€æ™ºæ…§ã€æµåŠ¨',
                'è‰®': 'åœæ­¢ã€ç¨³é‡ã€é™æ­¢'
            };
            
            const shangMeaning = meanings[shangGua] || '';
            const xiaMeaning = meanings[xiaGua] || '';
            const bianMeaning = meanings[bianGua] || '';
            
            return `${shangGua}ä¸Š${xiaGua}ä¸‹ï¼Œ${shangMeaning}åœ¨ä¸Šï¼Œ${xiaMeaning}åœ¨ä¸‹ã€‚åŠ¨çˆ»ç¬¬${dongYao}çˆ»ï¼Œå˜å¦ä¸º${bianGua}ï¼Œä¸»${bianMeaning}ã€‚`;
        }
        
        // ==================== å†å²è®°å½•åŠŸèƒ½ ====================
        function saveHistory(data, strokeCount) {
            try {
                const history = getHistory();
                const historyItem = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString(),
                    name: data.name,
                    date: data.date,
                    hour: data.hour,
                    shangGua: data.shangGua,
                    xiaGua: data.xiaGua,
                    dongYao: data.dongYao,
                    bianGua: data.bianGua,
                    isFavorable: data.isFavorable,
                    strokeCount: strokeCount
                };
                
                history.unshift(historyItem);
                
                // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
                if (history.length > 20) {
                    history.pop();
                }
                
                localStorage.setItem('bagua_history', JSON.stringify(history));
            } catch (e) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
            }
        }
        
        function getHistory() {
            try {
                const history = localStorage.getItem('bagua_history');
                return history ? JSON.parse(history) : [];
            } catch (e) {
                console.error('è¯»å–å†å²è®°å½•å¤±è´¥:', e);
                return [];
            }
        }
        
        function loadHistory() {
            const historyList = document.getElementById('historyList');
            const history = getHistory();
            
            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">æš‚æ— å†å²è®°å½•</p>';
                return;
            }
            
            let html = '';
            history.forEach((item, index) => {
                html += `
                    <div class="history-item" onclick="viewHistoryDetail(${index})">
                        <div class="history-header">
                            <span>#${index + 1}</span>
                            <span>${item.timestamp}</span>
                        </div>
                        <div class="history-content">
                            <p><strong>${item.name}</strong> (${item.date} ${item.hour}æ—¶)</p>
                            <p>å¦è±¡ï¼š${item.shangGua}ä¸Š${item.xiaGua}ä¸‹ | åŠ¨çˆ»ï¼š${item.dongYao} | å˜å¦ï¼š${item.bianGua}</p>
                            <p>çŠ¶æ€ï¼š${item.isFavorable ? 'âœ“ æœ‰åˆ©' : 'â–³ éœ€è°¨æ…'} | ç¬”ç”»ï¼š${item.strokeCount}</p>
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }
        
        function viewHistoryDetail(index) {
            const history = getHistory();
            if (history[index]) {
                const item = history[index];
                
                // æ¨¡æ‹Ÿé‡æ–°è®¡ç®—
                const fakeData = {
                    name: item.name,
                    date: item.date,
                    hour: item.hour,
                    shangGua: item.shangGua,
                    xiaGua: item.xiaGua,
                    dongYao: item.dongYao,
                    bianGua: item.bianGua,
                    isFavorable: item.isFavorable,
                    yearStemBranch: 'éœ€é‡æ–°è®¡ç®—',
                    monthStemBranch: 'éœ€é‡æ–°è®¡ç®—',
                    dayStemBranch: 'éœ€é‡æ–°è®¡ç®—',
                    hourStemBranch: 'éœ€é‡æ–°è®¡ç®—',
                    tianShiSum: 0,
                    hourStroke: 1
                };
                
                displayResult(fakeData, item.strokeCount);
                showSuccess('å·²åŠ è½½å†å²è®°å½•');
            }
        }
        
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('bagua_history');
                loadHistory();
                showSuccess('å†å²è®°å½•å·²æ¸…ç©º');
            }
        }
        
        // ==================== å·¥å…·å‡½æ•° ====================
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            const successDiv = document.getElementById('successMessage');
            successDiv.style.display = 'none';
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'none';
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }
        
        // ç»‘å®šå›è½¦é”®
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculate();
            }
        });
    </script>
</body>
</html>